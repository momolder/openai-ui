import type { RequestEvent } from '@sveltejs/kit';
import type { ChatMode, Conversation } from '$lib/models/Contracts';
import { streamResponse } from './../openAi';

export async function POST({ request, params }: RequestEvent) {
  const { conversation, chatMode } = (await request.json()) as {
    conversation: Conversation;
    chatMode: ChatMode;
  };
  const userMessage = conversation.messages.at(-2)?.content;
  if (userMessage?.includes('markdown')) {
    const content =
      '# Frösche: Faszinierende Amphibien\n\nFrösche gehören zu den faszinierendsten Lebewesen auf unserem Planeten. Sie sind Amphibien, was bedeutet, dass sie sowohl im Wasser als auch an Land leben können. In diesem kurzen Bericht erfahren wir mehr über ihre Lebensweise, Artenvielfalt und warum sie wichtig für das Ökosystem sind.\n\n## Artenvielfalt\n\nEs gibt über 6.000 Arten von Fröschen, die sich in Größe, Farbe und Lebensraum unterscheiden. Einige der bekanntesten Arten sind:\n\n- **Grüner Frosch** (*Rana clamitans*)\n- **Pfeilgiftfrosch** (*Dendrobatidae*)\n- **Laubfrosch** (*Hylidae*)\n\n### Lebensraum\n\nFrösche sind in fast jedem Klima auf der Welt zu finden, von tropischen Regenwäldern bis zu kälteren Regionen. Die folgende Tabelle zeigt einige Arten und ihre bevorzugten Lebensräume:\n\nSicher, ich kann Ihnen ein Beispiel geben, wie Sie eine Spalte hinzufügen und Informationen zu verschiedenen Froscharten aus verschiedenen Ländern eintragen können. Da ich jedoch nicht auf externe Datenquellen zugreifen kann, werde ich einige bekannte Froscharten und ihre Herkunftsländer als Beispiel verwenden. Hier ist, wie Ihre erweiterte Tabelle aussehen könnte:\n\n| Artname             | Wissenschaftlicher Name       | Lebensraum               | Land             |\n|---------------------|-------------------------------|--------------------------|------------------|\n| Rotaugenlaubfrosch  | Agalychnis callidryas         | Regenwälder              | Costa Rica       |\n| Europäischer Laubfrosch | Hyla arborea               | Wälder, Wiesen           | Deutschland      |\n| Amerikanischer Ochsenfrosch | Lithobates catesbeianus | Seen, Teiche             | USA              |\n| Goliathfrosch       | Conraua goliath              | Flüsse, Wasserfälle      | Kamerun          |\n| Japanischer Waldfrosch | Hyla japonica              | Wälder, Feuchtgebiete    | Japan            |\n| Australischer Grünbaumfrosch | Litoria caerulea      | Wälder, Gärten           | Australien       |\n| Seychellenfrosch    | Sooglossus sechellensis      | Tropische Wälder         | Seychellen       |\n| Tomatenfrosch       | Dyscophus antongilii         | Regenwälder, Sümpfe      | Madagaskar       |\n\nBitte beachten Sie, dass dies nur eine beispielhafte Tabelle ist und die Liste der Froscharten und Länder keinesfalls vollständig ist. Es gibt Hunderte von Froscharten weltweit, und viele von ihnen leben in mehreren Ländern oder Regionen. Wenn Sie spezifische Informationen zu Froscharten aus bestimmten Ländern benötigen, müssten Sie entsprechende Forschungen anstellen oder auf Fachdatenbanken zugreifen.\n\n#### Fortpflanzung\n\nFrösche sind bekannt für ihre einzigartigen Paarungsrituale und Laichgewohnheiten. Die meisten Arten legen ihre Eier im Wasser ab, wo sie sich zu Kaulquappen entwickeln und dann zu ausgewachsenen Fröschen metamorphosieren.\n\n##### Ernährung\n\nFrösche sind in der Regel Fleischfresser und ernähren sich von Insekten, Spinnen und sogar kleinen Wirbeltieren. Hier ist ein einfaches Python-Beispiel, das zeigt, wie man die Ernährung eines Frosches simulieren könnte:\n\n```python\n# Beispielcode: Froschernährungssimulator\n\nclass Frosch:\n    def __init__(self, name):\n        self.name = name\n        self.hunger = 0\n\n    def essen(self, nahrung):\n        print(f"{self.name} hat {nahrung} gegessen.")\n        self.hunger -= 1\n\n# Instanz eines Frosches erstellen\nkermit = Frosch("Kermit")\n\n# Kermit isst eine Fliege\nkermit.essen("eine Fliege")\n```\n\n## Wichtigkeit im Ökosystem\n\nFrösche spielen eine wichtige Rolle im Ökosystem:\n\n- Sie helfen bei der Kontrolle von Schädlingen, indem sie Insekten fressen.\n- Sie dienen als Nahrungsquelle für andere Tiere.\n- Ihre Hautsekrete haben medizinische Bedeutung.\n\n### Bedrohungen\n\nLeider sind viele Froscharten aufgrund von Lebensraumzerstörung, Klimawandel und Krankheiten bedroht. Schutzmaßnahmen sind dringend erforderlich, um diese wichtigen Tiere zu erhalten.\n\n#### Weitere Informationen\n\nFür mehr Informationen über Frösche und wie man sie schützen kann, besuchen Sie folgende Links:\n\n- [Save the Frogs!](https://www.savethefrogs.com)\n- [Amphibian Ark](https://www.amphibianark.org)\n\nListen wir zum Schluss einige faszinierende Fakten über Frösche auf:\n\n* Frösche können extrem weit springen, einige sogar über 20 Mal die Länge ihres Körpers.\n* Viele Frösche können ihre Farbe ändern; dies hilft ihnen, sich vor Raubtieren zu verbergen oder sich an ihre Umgebung anzupassen.\n* Die Haut von Fröschen ermöglicht ihnen nicht nur die Atmung, sondern auch die Aufnahme von Wasser.\n* Einige Froscharten hibernate im Winter, indem sie sich in den Schlamm eingraben oder unter Laubhaufen verstecken.\n* Der kleinste Frosch der Welt ist der *Paedophryne amauensis*, der nur 7,7 mm lang ist.\n\n### Wie man Frösche schützen kann\n\nHier sind einige Maßnahmen, die jeder ergreifen kann, um Frösche zu schützen:\n\n- Vermeiden Sie die Verwendung von Pestiziden und Chemikalien im Garten.\n- Schützen Sie lokale Feuchtgebiete und Gewässer.\n- Unterstützen Sie Organisationen, die sich für den Schutz von Amphibien einsetzen.\n- Fördern Sie die Aufklärung über die Bedeutung von Fröschen im Ökosystem.\n\nIn der Hoffnung, dass dieser kurze Bericht Ihr Interesse an diesen bemerkenswerten Kreaturen geweckt hat, denken Sie daran, dass jeder von uns dazu beitragen kann, die Zukunft der Frösche und das Gleichgewicht unseres Planeten zu sichern.';
    return streamResponse(content);
  }
  if (userMessage?.includes('vba')) {
    const content =
      'Sicher! Hier ist ein einfaches Beispiel für ein VBA-Skript, das in Excel verwendet werden kann. Es erstellt eine Nachrichtenbox, die die Summe der Zahlen in der ersten Spalte (A) des aktiven Arbeitsblattes anzeigt:\n\n```vba\nSub SumFirstColumn()\n    Dim ws As Worksheet\n    Set ws = ActiveSheet\n    \n    Dim sumRange As Range\n    Set sumRange = ws.Range("A1:A" & ws.Cells(ws.Rows.Count, "A").End(xlUp).Row)\n    \n    Dim total As Double\n    total = Application.WorksheetFunction.Sum(sumRange)\n    \n    MsgBox "Die Summe der ersten Spalte ist: " & total\nEnd Sub\n```\n\nSo führst du das Skript aus:\n\n1. Öffne Excel und gehe zu dem Arbeitsblatt, das du verwenden möchtest.\n2. Drücke `ALT` + `F11`, um den VBA-Editor zu öffnen.\n3. Im VBA-Editor, wähle `Einfügen` > `Modul`, um ein neues Modul zu erstellen.\n4. Kopiere und füge den obigen Code in das Modul ein.\n5. Schließe den VBA-Editor und gehe zurück zu Excel.\n6. Drücke `ALT` + `F8`, wähle `SumFirstColumn` und klicke auf `Ausführen`.\n\nDas Skript berechnet nun die Summe aller Zahlen in der ersten Spalte und zeigt das Ergebnis in einer Nachrichtenbox an. Achte darauf, dass du das Makro in einem vertrauenswürdigen Dokument ausführst, da Makros potenziell schädlichen Code enthalten können.';
    return streamResponse(content);
  }

  if (userMessage?.includes('table')) {
    const content = `Here is the requested table:\n\n| Item         | Price     | x In stock |\n|--------------|-----------|------------|\n| Juicy Apples | 1.99      | *7*        |\n| Bananas      | **1.89**  | 5234       |\n| Oranges      | **2.09**  | 0       |\n`;
    return streamResponse(content);
  } else {
    const content = `*${userMessage}* was your request with chatMode: **${chatMode}** and this is my answer from deployment **${params.deployment}**.`;
    return streamResponse(content);
  }
}
